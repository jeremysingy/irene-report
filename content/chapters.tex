%------------------------------------------------
% Contains the actual report content
%
% Author: Jérémy Singy
%------------------------------------------------

% Define a nice-looking C# logo for the text
\newcommand{\Csh}{C$^\sharp$}

% Chapters content

\chapter{Introduction}

\section{Context}

For several years, Carl Haber and his team at Lawrence Berkeley National Laboratory (\gls{lbnl}) have been working on the sound recovery of old mechanical records. They developed systems able to recover the sound from mediums using optical technologies, without any physical contact. These solutions are able to process many different record types, from early Edison cylinders to vinyl discs, including shellac or lacquer composed discs and others.

Nowadays, a lot of unique records remain in archives stored in different libraries, museums and academic institutions, containing materials of important historical and cultural value. Since most of them are recorded on aging and deteriorated mediums, it is often too delicate to play them with a normal mechanical phonograph. Non-contact feature of optical methods is then important.

The team at \gls{lbnl} first started to develop a system called \gls{irene}. It enables to extract the sound using digitized images of a disc. The installation for acquisition is completed by a software package that processes the extraction step, called \gls{rene}. Some time later, the development of a new project called \gls{3dprobe} started. Instead of capturing 2D images, the acquisition uses a special probe able to measure the real depth on the surface of the scanned record. This new system has enabled to process other types of records such as cylinders and is able to offer a better outcome with some specific mediums.

Meanwhile in Switzerland, at the College of Engineering and Architecture of Fribourg, another project called VisualAudio has been set up. It aims to archive discs that are deteriorating in a durable way so that the recordings can be heard years later. The discs are stored on a photographic film which is a support with a long life span. An application has also been developed, enabling to extract the sound using non-contact optical scanning in a way similar to \gls{irene}.

\section{Project goals}

Old records can suffer from degradations. One of the most common is known as ``cracked discs''. This problem appears when the lacquer coating shrinks as the disk is getting older. This causes cracks where the underneath hard support is visible, as seen in \autoref{fig:crackeddisc}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{images/cracked-disc}
\caption{An example of cracked disc.}
\label{fig:crackeddisc}
\end{figure}

Up to now, \gls{irene} and \gls{3dprobe} cannot automatically process such damaged records, because the groove traces are sometimes widely separated and may be shifted from each other. Though a special feature is implemented, enabling the user to manually track the traces, it is not a perfect tool for practical use. Moreover, even with such a feature, it could be really difficult to visually find the correct shifting when the traces look similar.

The aim of this Master's thesis is to find ways to read correctly these kinds of degraded records with the solutions developed at LBNL by Carl Haber and his team. In a first step, an improvement of the manual tracking will be implemented. It is still useful to keep it for some cases, e.g for special early recordings or when a disc is heavily cracked.

Then, the next step will be to design and implement a tracking feature able to process cracked records and link their traces automatically. VisualAudio already implements a feature enabling to track cracked discs in an automatic or semi-automatic way. It can then be taken as an example, though it will obviously not be possible to directly adopt its implementation, as the systems are quite different.

%\section{Report structure}

%TODO This report is separated in...

\chapter{Phonograph cylinders and records}

This chapter will give a quick historical overview of the different mechanical phonograph technologies and the types of mediums encountered. It will also explain the main principles behind the analog recording

\section{History}

The first known sound recording was realized by the French printer Édouard-Léon Scott de Martinville in 1860. However, the used device called the \emph{phonautograph} was not able to playback the recordings. It rather acted as an early oscilloscope and was used by scientists to study visual representations of the sound.

The phonograph was created by Thomas Edison in 1877. It was the first device able to record \emph{and} reproduce the sound. The general principle was to mechanically engrave the audio signal on a rotating cylinder. The resulting groove undulated then vertically. Then, for the playback, a stylus (needle) retraced the groove and was able to reproduce the sound waves from the generated vibrations. Finally, the signal was amplified with a horn so that the recording was audible. A newer version of this phonograph and an example of cylinder are presented in \autoref{fig:edisonphonocyl}.

\begin{figure}[!ht]
    \begin{subfigure}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.8\textwidth]{images/edison-phonograph}
    \caption{An Edison phonograph.}
    \label{fig:edisonphono}
    \end{subfigure}
    \begin{subfigure}[b]{0.45\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{images/edison-cylinder}
    \caption{An Edison wax-cylinder.}
    \label{fig:edisoncyl}
    \end{subfigure}
    \caption{Pictures of Edison wax phonograph and record.}
    \label{fig:edisonphonocyl}
    %\floatfoot{Norman Bruderhofer, www.cylinder.de}
\end{figure}

Since then, the phonograph has been used as the only device for sound reproduction until around the 1950's when the magnetic tape has become widely used on the market. From the first Edison's version, a lot of improvements have been made. Edison used first a tinfoil around the cylinders to engrave the groove. However, this material gave bad quality and was rapidly degrading. Alexander Graham Bell started to use wax-coated cylinders instead of the tinfoil, which improved a lot the sound quality.

Then, in the early twentieth century, the cylinders were gradually replaced by the gramophone records which were flat discs that could be double-sided. On the latter, the groove undulated laterally instead of vertically.

After the wax-cylinders, a lot of different materials have been used for the discs covering. For example, the shellac discs became the first widely used medium. Some discs were also using a special lacquer coat. Finally, the vinyl disc is one of the last types of gramophone record and is still being used today.

\section{Basic principle}

\subsection{Edison phonograph}

With the early Edison phonograph, the same device was used to record and play the sound. As already explained, the sound is mechanically engraved with a needle. In fact, the needle is connected to a diaphragm that vibrates when audio waves are emitted. The cylinder is put on a mechanism which can be rotated by a crank and that shifts slowly resulting in helical grooves, as represented in \autoref{fig:phonoschema}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{images/phono-schema}
\caption{Schema of a simple phonograph.}
\label{fig:phonoschema}
\end{figure}

Then, to reproduce the recorded sound, the cylinder is repositioned at its starting position. The needle is placed with slightly less pressure, and when the crank is turned, the needle follows the groove which vibrates the diaphragm and returns the sound waves. This is in fact the exactly inverse process as the recording.

\subsection{Record types}
\label{sec:rectypes}

\subsubsection{Groove modulation}

The Edison phonograph uses a groove that undulates vertically. However, a lot of records, particularly the discs, have used laterally modulated grooves. This way, it is no more the depth that determines the signal, but rather the lateral position of the groove bottom. The difference can be clearly seen in \autoref{fig:groovesdiff}.

\begin{figure}[!ht]
    \begin{subfigure}[b]{0.49\textwidth}
    \centering
    \includegraphics[width=0.8\textwidth]{images/grooves-vertical}
    \caption{Vertically modulated.}
    \label{fig:groovesvert}
    \end{subfigure}
    \begin{subfigure}[b]{0.49\textwidth}
    \centering
    \includegraphics[width=0.8\textwidth]{images/grooves-lateral}
    \caption{Laterally modulated.}
    \label{fig:grooveslat}
    \end{subfigure}
    \caption{The two types of groove modulation.}
    \label{fig:groovesdiff}
\end{figure}

It exhibits a 3D representation of record surfaces for both groove types. In \autoref{fig:groovesvert} the boundaries are straight and the depth varies while in \autoref{fig:grooveslat} they form an horizontal wave.

\subsubsection{Revolution per minute}

Another important parameter is the number of revolutions per minute, abbreviated \emph{rpm}. It represents the rotational speed of the record while recording or playing. The speed of early records was not standardized, and it could vary from \SIrange[range-units=single]{60}{160}{rpm} for cylinders. Then, the speed has been progressively standardized to the common \SI{78}{rpm}. A lot of recording material to be restored now uses this format. The newer vinyl discs have then used the well-known speeds of \SI{33}{rpm} and \SI{45}{rpm}.

\section{Summary}

This chapter gave an idea of the phonograph history and different devices, showing the heterogeneous nature of the audio recording, with a lot of different techniques and materials. This outlines the difficulties that might appear while trying to recover old recordings.

The next chapter will discuss the technology developed at \gls{lbnl} in order to extract optically the sound from old records.

\chapter{Acquisition and processing systems}
\label{chap:acqprocsys}

This chapter details the systems used in the audio laboratory at \gls{lbnl} to extract records. For both systems, the main process is separated in two main steps: the acquisition and the processing.

\section{IRENE}

\subsection{Acquisition}

As already explained, \gls{irene} uses numerical macro photography for the acquisition. The scanner takes some monochromatic pictures of the disc. The resulting image is influenced by the shape of the surface because of the light reflection. Therefore, the intensity of the resulting pixels depends finally on the slope of the surface.

This enables to visually find the grooves on the resulting picture. An example of such a picture is shown in \autoref{fig:irenecapex}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{images/irene-capture-ex}
\caption{IRENE capture excerpt.}
\label{fig:irenecapex}
\end{figure}

A single groove can be seen as two black strips with a thin bright line in between. The black parts represent the edges (higher slope) while the thin line is the bottom of the groove (very little slope, almost flat). Between two grooves, the structure is approximately flat, so the reflected color is also white. \autoref{fig:irenegroove} illustrates these different parts.

\begin{figure}[!ht]
\centering
    \begin{subfigure}[t]{0.29\textwidth}
    \centering
    \raisebox{0.3cm}{\includegraphics[width=4cm]{images/irene-grooves}}
    \caption{Two scanned grooves.}
    \label{fig:irenegrimg}
    \end{subfigure}
    \begin{subfigure}[t]{0.7\textwidth}
    \centering
    \includegraphics[width=9.5cm]{images/irene-grooves-schema}
    \caption{The corresponding shape.}
    \label{fig:irenegrschema}
    \end{subfigure}
    \caption{Visualization of scanned grooves.}
    \label{fig:irenegroove}
\end{figure}

\autoref{fig:irenegrimg} represents two grooves as they appear from the acquisition part. The approximate corresponding shape in a sectional view is visualized in \autoref{fig:irenegrschema}.

\subsubsection{Capture properties}

The camera cannot take a whole picture of one disc in a snapshot. It captures a line of \SI{3.072}{\milli\metre} with \num{4096} pixel samples. For a total disc revolution, \num{80000} lines are captured this way. Therefore, it results in an image of \SI[product-units=single]{4096x80000}{px} representing a ring-shaped disc capture in polar coordinates. To simplify the manipulation, the high resolution image is exported as eight separate pictures of \SI[product-units=single]{4096x10000}{px} easier to process.

For a \SI{78}{rpm} disc, the time for one revolution $t_{cyc}$ is the inverse of the rotational speed $w_{cyc}$. Therefore, the sampling rate $f_s$ for the system is given by
%
\begin{equation}
\label{eq:samprateirene}
f_s = \frac{n_{sample}}{t_{cyc}} = \frac{n_{sample}}{\frac{1}{\omega_{cyc}}} = \frac{\num{80000}}{\frac{1}{\SI{78}{rpm} \cdot \SI[quotient-mode=fraction]{1/60}{\metre\per\second}}} \approx \SI{104}{\kilo\hertz}
\end{equation}
%
This value satisfies the sampling theorem\footnote{The Nyquist–Shannon sampling theorem states that the minimum sampling frequency should be greater than twice the maximum of the sampled signal to reconstruct it properly. As the human hearing have a range from \SIrange[range-units=single]{20}{20000}{\hertz}, the sample rate for audio signal must be at least \SI{40}{\kilo\hertz}.} as it is greater than the minimum of \SI{40}{\kilo\hertz}.

\subsection{Processing}
\label{sec:reneprocessing}

After the acquisition, the original record is digitized and can be archived on digital media. To extract the sound, the next step is to use the \gls{rene} program. It offers features to process the record images and output the final corresponding sound as a \gls{wav} file.

\gls{rene} embeds a lot of algorithms and parameters to adapt at best the processing to the different record types. It is written in the \Csh{} programming language, enabling to easily build a complete graphical application without the use of third-party libraries. The \gls{gui} simplifies its utilization and offers the possibility to visually follow the tracking, as seen in \autoref{fig:irenegui}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{images/rene-gui}
\caption{The IRENE user interface.}
\label{fig:irenegui}
\end{figure}

The left panel is used to specify the different parameters and algorithms for the separate steps and more generally to control the application. The upper right panel shows the processed record image. When the tracking is applied, the detected edges are directly drawn on top of the image. The panel at the bottom presents diverse information and statistics on the records.

The whole processing is applied in several steps.

\subsubsection{Tracking}

The tracking is the first step to process a disc. It enables to approximately find the groove positions on a record using different detection algorithms. These latter are performed on a representation of the disc which is binned in the vertical axis by a certain factor (typically around \numrange[range-phrase=--]{20}{30}). This results in a general bitmap representation of the record much smaller than the original resolution. It is actually the one seen in the upper right panel (see \autoref{fig:irenegui}).

Due to the small bitmap size, this processing is consequently very efficient and not subject to possible noise or imperfections which are smoothed by the binning. In the user interface, the result of this step can be viewed on the top-panel as the purple and red external lines delimiting the grooves as seen in \autoref{fig:irenegui}.

Several different algorithms (explained in detail in \autoref{sec:trackmethods}) can be selected to track the grooves. The best one to apply depends on the scanned medium and its general condition. As already mentioned, there is also an option to manually define the groove position when automatic methods are not applicable (e.g. if the disc is too damaged). The user can directly select points that define an interpolated line, which must follow the edge of the groove. This feature will be further explained in \autoref{sec:mancurrentimpl}.

\subsubsection{Image processing}

The next step is the actual processing. When the grooves are tracked, it remains to precisely find the groove center, which defines the sound information. Again, different algorithms can be used as methods using the derivative, thresholding, etc.

The result is the precise groove bottom defined between the blue and green traces on \autoref{fig:irenegui}.

\subsubsection{Sound processing}

Finally, it remains to create the output \gls{wav} file from the tracked groove bottom positions. At this step, some filters can also be applied to improve the sound quality.

\subsection{Architecture}

The diagram in \autoref{fig:renearchi} presents the general architecture of RENE.

\begin{figure}[!ht]
\centering
\includegraphics{diagrams/rene-gen-design.1}
\caption{General architecture of RENE.}
\label{fig:renearchi}
\end{figure}

The program does not use object-oriented design. The business logic and processing parts are embedded in the \texttt{Form1} class which also represents the view of the application (inheriting from the .NET WinForms \gls{api}).

Dependencies between the different classes are then fairly simple. Some tasks have been separated in external classes contained in the \texttt{Form1} class, as for the groove tracking or image processing which includes in fact routines to load images into bitmaps. The \texttt{DB} class handles connection and communication with a database, used to automatically store information and statistics on the processing results in a centralized database.

Some common processing tasks are separated in different utility classes, e.g. \gls{fft} algorithm or \gls{wav} processing to output the sound file.

\section{3D Probe}

\subsection{Acquisition}

With \gls{3dprobe}, the acquisition stage is the main difference. Instead of using a regular camera, a special probe is used, getting the actual depth for each point over a scanned part. This gives a real heightmap of the disc surface, as shown in three-dimensional view in \autoref{fig:groovesdiff}.

To measure the height of the scanned surface, the sensor takes advantage of the chromatic aberration \footnote{Optical distortion occurring when a lens cannot properly focus all colors of a same point due to different refractive indices for different wavelengths of the light.}. Light is emitted and passes through an objective. Because the refraction index depends on the wavelength, the light is refracted differently regarding the wavelength, as shown in \autoref{fig:chromaber}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.8\textwidth]{images/chromatic-aberration}
\caption{Chromatic aberration through a lens.}
\label{fig:chromaber}
\end{figure}

Hence, the color reflecting in focus on the surface will depend on the distance from the lens. The sensor captures then the reflected wavelength and can deduce the height. The probe can also give the value of the brightness, that is, the captured light intensity for a given point.

\subsubsection{Capture properties}
\label{sec:3dcaptureprop}

In a single snapshot, the sensor is able to capture 180 points in one line of \SI{1.8}{\milli\metre} in a way similar to the 2D camera with \gls{irene}. The depth is measured in a range of \SI{400}{\micro\metre} with a resolution of \SI{0.125}{\micro\metre}.

The acquisition software outputs the data in a specific binary file format with extension \emph{.pri}, containing essentially floating-point values corresponding to the depth captures. The brightness is stored separately in a \emph{.bri} file, using exactly the same structure.

In this case, the number of samples for a full revolution depends on the angle $\alpha$ by witch the cylinder is rotated between two samples. Therefore, the sampling rate is not fixed and the formula for a cylinder at \SI{160}{rpm} become
%
\begin{equation}
\label{eq:samprate3d}
f_s = \frac{n_{sample}}{t_{cyc}} = \frac{n_{sample}}{\frac{1}{\omega_{cyc}}} = \frac{\frac{\ang{360}}{\alpha}}{\frac{1}{\SI{160}{rpm} \cdot \SI[quotient-mode=fraction]{1/60}{\metre\per\second}}}
\end{equation}
%

For example, with an angle $\alpha$ of \ang{0.02}, the number of samples is $\frac{\ang{360}}{\ang{0.02}} = \num{18000}$ and the sampling rate become $\frac{\num{18000} \cdot 160}{60} = \SI{48}{\kilo\hertz}$.

\subsubsection{Multiple-pass acquisition}

From the capture properties, the distance between two points is \SI{10}{\micro\metre}. The corresponding resolution is then quite low and could not be enough in some cases.

Therefore, the \gls{labview} acquisition software is able to perform a multiple-pass scanning. The same part a record is captured several times with a different shift. For example, by using two-pass, the number of points, and so the resolution are multiplied by two resulting in 360 points for the same distance.

\subsection{Processing}

The processing is done with the program called \gls{prism}. It uses the data stored in the \emph{.pri} and \emph{.bri} files to process and output the sound. The application is very similar to \gls{rene} and is also written in \Csh. There are also a lot of different parameters to tune the tracking and processing at best for the corresponding record type. Some parameters are also specifically related to cylinder processing.

The user interface (\autoref{fig:prismgui}) embeds approximately the same main parts as \gls{rene}, though differently disposed.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{images/prism-gui}
\caption{The PRISM user interface.}
\label{fig:prismgui}
\end{figure}

The parameters and algorithms can be set on the top panel. In the middle and the right, the scanned media is visualized as a 2D heightmap. The dark and bright colors emphasize the higher, respectively the lower points on the surface. The image at the left-hand side is a general view while the other one shows a full resolution portion of the record (selected with the cursor and highlighted with the red square on the left panel). The lower panel gives the same type of information as the other program.

\subsubsection{Processing steps}
\label{sec:3dprocsteps}

The processing part is performed through the same steps as with \gls{rene} (see~\autoref{sec:reneprocessing}). The main point is to take into account that a pixel value now denotes a real height and no more a brightness difference as on a photography. Likewise, the 3D acquisition suffers from bad points, that is, pixels with incorrect height value coming from the acquisition. Special algorithms are then set up to clean the scanned data and suppress these bad points.

Finally, the cylinder processing algorithm is specific, as it considers of course the vertically engraved nature of these type of record (see~\autoref{sec:rectypes}). The waveform is indeed defined by the surface height in the groove bottom (the intensity in the heightmap) and not by its lateral position.

\subsection{Architecture}
\label{sec:prismarchi}

The general architecture of \gls{prism} is presented in \autoref{fig:prismarchi}.

\begin{figure}[!ht]
\centering
\includegraphics{diagrams/prism-gen-design.1}
\caption{General architecture of PRISM.}
\label{fig:prismarchi}
\end{figure}

The \gls{prism} program have a refined architecture, using more object-oriented facilities. The \gls{gui} is handled by the \texttt{frmMain} class. The big part of the business logic has been separated in its own class \texttt{Hardware}. This class represents an abstract record which is processed by the application. A inheritance hierarchy is built from it, mainly separated in \texttt{Cylinder} and \texttt{Disc} types representing vertically and laterally engraved records. This design enables to specialize the algorithms for any types of records.

Other utility classes handle common processing such as \gls{wav} creation or signal cleaning algorithms.

\section{Acquisition hardware}

Both \gls{irene} and \gls{3dprobe} use the same hardware for the acquisition. It consists of different sensors and motors connected to a controller. This controller is itself driven by a software, using a special library embedded in a \gls{labview} environment.

\subsection{Components}

There are two main different supports. The first one is a turntable specifically designed for flat discs with the scanner put vertically and the disc rotating horizontally. The second one enables cylinder scanning, the probe being placed horizontally and directly facing the record. \autoref{fig:labhw} represent the installation in the laboratory.

\begin{figure}[!ht]
    \begin{subfigure}[b]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{images/hardware-irene}
    \caption{The turntable to acquire flat discs.}
    \label{fig:labirene}
    \end{subfigure}
    \begin{subfigure}[b]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{images/hardware-3d}
    \caption{The scanning equipment for cylinders.}
    \label{fig:lab3d}
    \end{subfigure}
    \caption{The acquisition hardware as installed at LBNL.}
    \label{fig:labhw}
\end{figure}

In both cases, in addition to the rotary motor, there is a X- and Z- shifting motor. The X-motor enables to shift the record to scan another portion. The Z-motor is used to adapt the sensor height for a correct focus.

\subsection{Z-correction}
\label{sec:zcorr}

Small differences can cause the 2D image to be blurred or the 3D scan to be out of range. To avoid this problem, a Z-shift correction is applied. The height shifting is controlled using a laser displacement sensor. It follows up the record and adjusts the sensor height, acting as an ``autofocus system''.

\section{Typical records issues}

As already stated, a lot of important and historical recordings are still stored on old records without other copies. Many of them can no more be read with regular phonographs. \gls{irene} and \gls{3dprobe} systems can then be used to restore the sound. However, some of the recordings are already altered, e.g. with some cracks appearing on disc surface, or completely broken into pieces, as old cylinders. These latter can still be acquired in several steps by strapping the pieces together, resulting in the same kind of issues in the processing step.

Depending on the degradation level, other issues can also appear with optical methods. In some cases the systems are still not able to perform a proper scan. The next sections depict the most common problems.

\subsection{Shifting}
\label{sec:issueshift}

Visible cracks on a record as shown in \autoref{fig:crackeddisc} is only the tip of the iceberg. Usually, it involves other problems to be solved algorithmically. One of the most common problem is shifting. When different parts of a disc surface are separated because of the cracks, they typically move slightly from each other, resulting in grooves mismatch. An example of this kind of issue is illustrated in \autoref{fig:shiftedgrooves}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{images/shifted-grooves}
\caption{Grooves shifted because of a crack.}
\label{fig:shiftedgrooves}
\end{figure}

The acquisition shows clearly the two distinct pieces separated by a arch-shaped crack. In this case, the grooves are only slightly shifted. However the difference can be much larger and exceed up to several grooves large, causing difficulty to visually find the correct matching.

\subsection{Focus}

As explained in \autoref{sec:zcorr}, the acquisition needs always to stay in focus to get a sharp image. However, when the height varies abruptly, the laser is not able to directly compensate the Z-shift. This can happen sometimes when the lacquer inflates resulting in bubbles on the surface. The result in the acquisition is shown in \autoref{fig:blurredgrooves}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{images/blurred-grooves}
\caption{Blurred grooves on the bottom part under the crack.}
\label{fig:blurredgrooves}
\end{figure}

\subsection{Other issues}

Other problems may occur because of the cracks. For example, because of the lacquer deformation, the pieces can sometimes expand or shrink, which results in other corrections to apply. Likewise, the gaps introduced by the cracks can sometimes be large and the resulting sound affected. Most of time, the gap is not a loss of content but rather a separation due to the shrinkage. Yet the reciprocal can also happen, i.e. when a piece of lacquer coat is folded on another one.

The trouble is to find out what is the best interpolation scheme to match the sound between the cracks. Furthermore, these latter issues become more important when a sound has to be synced with a visual representation, as for a movie sound track for example. The sound must match the picture so that the film is properly watchable.

\section{Sample recordings}
\label{sec:samplerec}

To investigate properly on the previously discussed issues, a canonical test set has been provided by the laboratory. These samples gather the typical problems that the current software components are unable to process correctly. Their properties as well as a general analysis of the related issues will be detailed in the next sections.

\subsection{Graham Bell disc}

A collection of Graham Bell records\footnote{More information on the recovered collection can be found on this IRENE web page: \url{http://bio16p.lbl.gov/volta-release.html}.} has been recovered in the \gls{irene} laboratory. This collection comes from the Volta Laboratory created by Alexander Graham Bell. One of the disc in the collection, labeled 287700, is a vertically-cut wax disc. It can be viewed in \autoref{fig:belldisc}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{images/bell-disc}
\caption[The Graham Bell 287700 disc.]{The Graham Bell 287700 disc. The radial cracks are clearly visible on the photography.}
\label{fig:belldisc}
\end{figure}

This record is cracked and the specific cracks are clearly visible as black traces on the support, revealing the material underneath the wax layer visible in a yellowish color. This disc has been acquired with the \gls{3dprobe} system, but the program is not able to properly process it. Indeed, one can clearly see that groove shifting can appear when a crack is reached, as in \autoref{fig:bellcrack}, making it impossible to track.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{images/bell-crack}
\caption{A crack on the 287700 disc as it appears in PRISM (detail image).}
\label{fig:bellcrack}
\end{figure}

On the whole record, the shifting does not seem to be very large. There is no more than one groove width of shifting in this case.

\subsection{Dickson cylinder}

This specific wax cylinder comes from an experimental project by William Dickson and Thomas Edison. It is the soundtrack recording for the first film with recorded sound in addition to the motion picture. It is then an early prototype of a sound-film, but without real synchronization between picture and sound. This first attempt of a sound-film is known as the \emph{Dickson Experimental Sound Film}.

This cylinder is seriously damaged and contains, in addition to cracks, big areas where the grooves are removed, probably due to a piece of layer that has been entirely broken. This problem can be visualized in \autoref{fig:dicksonbig}. A smaller example of a crack is presented in \autoref{fig:dicksoncrack} as it is viewed from \gls{prism} in full resolution.

\begin{figure}[!ht]
\centering
    \begin{subfigure}[t]{0.49\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{images/dickson-damage-big}
    \caption{A damaged area as seen in binned view.}
    \label{fig:dicksonbig}
    \end{subfigure}
    \begin{subfigure}[t]{0.49\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{images/dickson-crack}
    \caption{A small crack in detailed view.}
    \label{fig:dicksoncrack}
    \end{subfigure}
    \caption[Damages on the Dickson cylinder.]{Damages on the Dickson cylinder. In both images, the vertical grooves are hardly noticeable because when an irregularity occurs the depth difference is much bigger than the usual groove height (this is only a visualization issue).}
    \label{fig:dicksondamage}
\end{figure}

However, even with these missing parts, the shifting remains once more quite small, and the right path is quite easy to spot for a human.

\subsection{Boas recording}

Franz Boas was a famous anthropologist born in 1858 in Germany. He moved to the United States in 1887 where he started to study American Indian populations. During his researches and expeditions, Boas recorded a lot of material. Some of these records have been acquired with \gls{3dprobe} for restoration some time ago. One of the disc in the collection, labeled 0724, is a damaged wax cylinder.

As every cylinders, it was acquired with the \gls{3dprobe} system. This record suffers from a lot of cracks separating the data in several pieces. These separated pieces can then be quite small. \autoref{fig:0724cracks} represents a portion of the disc after the acquisition.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.7\textwidth]{images/0724-cracks}
\caption{Excerpt of the acquisition of the 0724 cylinder as seen from the binned image in PRISM.}
\label{fig:0724cracks}
\end{figure}

The grooves are clearly visible but when a crack appears, the correct matching between the different parts is difficult to spot because they are almost always shifted. Even for human eyes, the right way is difficult to follow. \gls{prism} currently fails to properly track the grooves on this record.

\subsection{Brigance recording}

William Norwood Brigance was a teacher at Wasbash College and was also the leader in the Speech Association of America. He his well-known for his work in rhetoric, teaching people how to effectively speak and improve the communication. Some of his audiovisual material has been brought to the laboratory for restoration. One of these record is a lacquer disc with many cracks.

This disc is the only one in the test set that has been acquired with the \gls{irene} system, as it is a laterally-cut disc. Many cracks can be seen the scanned medium, as viewed from the acquisition in \autoref{fig:brigdamage}.

\begin{figure}[!ht]
\centering
    \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{images/brigance-cracks}
    \caption{General view (binned image).}
    \label{fig:brigcracks}
    \end{subfigure}
    \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{images/brigance-crack-detail}
    \caption{Detailed view of a particular crack.}
    \label{fig:brigcrackdet}
    \end{subfigure}
    \caption{The Brigance disc as viewed from the RENE program.}
    \label{fig:brigdamage}
\end{figure}

We can clearly see from the binned image in \autoref{fig:brigcracks} many irregularities due to the cracks. However, the shifting is narrow and the general path to fellow seems obvious. The detailed view in \autoref{fig:brigcrackdet} shows however that the crack is very thin, making it difficult to detect.

\subsection{Conclusion}

All provided samples are unique and show a lot of different properties according to the mediums and their condition. This means that a general solution for this problem is difficult to come up with. Some parameters will then probably have to be chosen to adapt the future solution to different types of medium. In the worst cases, the user intervention to help tracking the grooves may be mandatory.

\section{Summary}

This chapter presented an overview of the solutions developed at \gls{lbnl}. It covered the two systems, \gls{irene} and \gls{3dprobe}, both in terms of software and hardware. It also presented the common issues appearing while processing damaged audio records, and the test set provided by the laboratory with its specific properties. These samples will be used to test the new features.

The following chapters will cover the existing ways of figuring out these issues, and present new features implemented during this thesis to improve and ease the recovery of these damaged records.

\chapter{Manual tracking}

This chapter explains how we improved the manual tracking. Because there are a lot of different mediums and the same amount of issues coming with, it is not likely to find the best solution to solve each of them. There are some recordings to be recovered that have particular and unique issues, appearing only in a small section of the record. Likewise, some small artifacts can appear visually easy to catch and fix for the human eye, but very tricky to solve with a particular algorithm.

Therefore, for this kind of thing, falling back to a manual tracking can be the more appropriate solution.

\section{Current implementation}
\label{sec:mancurrentimpl}

As summarized in \autoref{chap:acqprocsys}, both \gls{rene} and \gls{prism} feature similar manual groove tracking. The system is simple but useful on specific cases. To start tracking, the user must select the proper option in the tracking options. When clicking on the general record view with the CTRL key pressed (left image on \gls{prism}), a first tracking point is stored. Then, each successive click adds a new point and a polyline is drawn connecting all previous points, giving the general track path as seen in \autoref{fig:mantrackprism}.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.5\textwidth]{images/manual-tracking-prism}
\caption{Manual tracking example in PRISM.}
\label{fig:mantrackprism}
\end{figure}

The program offers the possibility to store the tracked coordinates in a file to be used later. Finally, when the user applies the tracking, all points are interpolated and the processing step starts as usual.

\subsection{Limitations}

The current implementation is suitable to handle some complicated cases but suffers from several limitations:

\begin{itemize}
\item Unnatural way to draw a path over an image.
\item Tracking points can be manually put only on the binned (left) image, which can lack of precise information, especially if the scanned part is big and the record is cracked or damaged.
\item No possibility to undo parts already traced.
\item Tracking a whole record manually is a very slow process.
\end{itemize}

\subsection{Suggestions for improvement}

Regarding the previous limitations, several proposals were made at the project startup to find ways to improve the user experience and enhance the tracking efficiency.

\subsubsection{Touchscreen interface}

One of the concepts was to use a touchscreen interface. Nowadays, a lot of people are used to these interfaces such as tablets, smartphones, etc. Moreover, following a trace on a touch screen with the finger or a stylus seems to be user-friendly. This interface could also be convenient to re-align broken discs with shifted grooves (see \autoref{sec:issueshift}).

However, using a tablet would imply working on a specific operating system which would not be compatible with the current applications. It would be possible to implement a communication interface between the standard application and the UI but another problem could arise: these devices have mostly a limited capacity, while the amount of data processed for the sound recovery is very large. Nevertheless, using a simple touch screen within the current system and adapt the interface accordingly is still worth considering.

\subsubsection{Interactive tracking}
\label{sec:inttrack}

Another idea was to develop an \emph{interactive} way of tracking the grooves. The interface would display the groove scrolling \emph{continuously}, and the user would have to correct the lateral position to stay over the groove center.

The scrolling speed must be adaptable so that the tracking is convenient in different situations. Over areas where the surface is clean, it can be fast because there is no big correction to fix the track. When the right way is less obvious, the user can slow down and stop to choose the right way.

The zoom could also be adapted regarding of the speed. When the speed is slowed down, the zoom factor is greater to see precisely a specific part. When the speed is high, the user does not need to see the groove scrolling rapidly but should instead have an overview to stop at the next difficult point.

In fact, this feature could also be seen as a more entertaining way for this kind of work, because it could look like a ``game'' because of its animated and lively interface.

\subsubsection{Further improvements}

Beyond a brand new specific interface, other improvements to the user experience can be made to ease and accelerate the manual tracking.

The ability to undo what was done so far to be able to correct a wrong decision is a useful feature. Likewise, it could be gainful to be able to put some annotations before actually track the grooves. \gls{rene} and \gls{prism} already offer information and statistics about the scanned record. For example, one could notice that the signal on the graph between two shifted grooves is similar. It would then be possible to click on the specific ends to indicate that they are likely to be linked together for the tracking.

\subsection{Summary}

The current user interface for manual tracking is functional but can still be improved in many ways. The concept for a touchscreen interface is interesting but not easily applicable in the current state of the system. Therefore, the interactive method seems to be a good idea and its design and implementation is detailed in the next sections.

\section{Interactive tracking}

This section presents the interactive tracking feature as it has been integrated into the \gls{prism} program. The next subsections present it in terms of graphical interface, explain its utilization and detail its implementation.

\subsection{Graphical design}

\subsubsection{Location and integration}

As the current interface is already overflowed with all existing parameters and options, it is important to add the new feature so that it is integrated smoothly in the existing application, without making it tedious to use.

As seen in \autoref{fig:prismgui}, the interface is already able to show a detailed part of the disc on the right panel. When the user clicks on this detailed part, he can visualize other information on the signal. However, it is not designed to be interactive. In fact, each time the user selects a part on the right image, the corresponding part is reloaded and stored in a bitmap to be drawn on screen. The whole process is too time-consuming for an interactive drawing though it is suitable for its purpose.

The new feature has then to be separated from this detailed view. It has been chosen to put a tabbed panel to choose between the two configuration. As the user will not need both features at the same time, this is a suitable solution.

\subsubsection{Tracking panel}

The interactive tracking panel is separated in two parts: controls and visualization. The first part enables the user to manage and edit the different options while the second represents the record scan which the user has to follow to indicates the grooves. \autoref{fig:intpanelprism} represents the whole panel.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{images/int-track-panel-prism}
\caption{Interactive tracking panel in PRISM.}
\label{fig:intpanelprism}
\end{figure}

The controls enable to monitor the tracking by changing several parameters such as the speed or the zoom level. As explained in \autoref{sec:inttrack}, the zoom can also be locked regarding to the speed, using the corresponding option.

\subsection{Principle of operation}

To use the interactive tracking, the user first selects the corresponding button in the tracking options. Then, when the record is loaded, the corresponding disc is visible in the interactive panel. A red triangle acts as a beacon to clearly see the current tracked position.

When the user clicks on the panel and moves the cursor, the horizontal position moves accordingly. The goal is then to place the triangle tip on the center of the groove. While maintaining the mouse button pressed, the user may then increase the speed by using the mouse wheel. The record scrolls vertically while the horizontal position is still following the cursor.

To actually start the tracking, i.e. keep track of the points interpolated, the user must click the \emph{Play} button on the left.

\subsubsection{Synchronization between views}

The interactive view and the global view on the left are always synchronized. The current tracked position is visualized on the left panel of the application as a small red square and moves accordingly. When the tracking is performing, the corresponding polyline is drawn on the left part, as seen in \autoref{fig:intsynctrack}. The path is also represented in the right panel, so that the user is able to see which was the previous tracked groove before starting the next one.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{images/int-track-sync}
\caption{Interactive tracking synchronized with the global view.}
\label{fig:intsynctrack}
\end{figure}

When the left panel is clicked, the position in the interactive panel is also changed accordingly. When the tracking is running (the \emph{Play} button is pushed), a click on the panel also has the effect of adding an interpolation point. In fact, this acts in the same way as the original manual tracking. It is useful for some areas where the disc is in good quality and passing through the entire groove interactively would be too long. The user can easily switch between the two alternatives while tracking a record.

\subsubsection{Undo option}

One of the problems that happens with the manual tracking is the lack of an option to undo the last actions. It appears quite frequently that the last action is improper resulting in a bad tracking. The interactive tracking offers the possibility to undo the steps up to the starting point.

\subsubsection{Groove center correction}

Another feature which has been added is the correction of the actual position to match the very center of the groove. In fact, the system is able to precisely find the groove center once the it is known which one is the current one to track. The user involvement is then more a way for helping the system to choose the correct groove from an approximated position.

The user will then see two triangles. A red one which is fixed and represents the position that the user points out, and the blue one which shifts to the deepest position in the surrounding area.

\subsection{Design and classes organization}

This part of the implementation is much about user interface and does not require a lot of processing. The main point is to find an appropriate way of integrating the new feature without blowing up the existing codebase which is already quite complex (see~\autoref{sec:prismarchi}).

The new feature has been implemented essentially in two new classes called \texttt{InteractiveControl} and \texttt{DrawPanel} as represented in the diagram of \autoref{fig:inttrackprismdiag}.

\begin{figure}[!ht]
\centering
\includegraphics{diagrams/int-track-prism.1}
\caption{Class diagram for the interactive tracking in PRISM.}
\label{fig:inttrackprismdiag}
\end{figure}

The first one embeds the whole control with the controlling part (toolbox) and the visualization path. It is a specific control and inherits the \texttt{UserControl} class of the WinForms \gls{api}. The specific interactive part drawing the record is handled by the second class. It inherits from the WinForms \texttt{Panel} class. Another class called \texttt{BeaconTriangle} has been created to simplify the rendering of the blue and red triangles indicating the tracked position.

The interactive panel is owned by the \texttt{frmMain} class already created in PRISM. It uses the \texttt{Hardware} class for the communication with the record information, e.g. to get the original bitmap or set the points building the tracking path. The reference to \texttt{PictureBox} called \texttt{pict} and \texttt{picture} point to the same instance. It represents the left panel showing the global view. The \texttt{InteractiveControl} class needs it to force the drawing when the values are updated (e.g. while points are being added).

An utility class called \texttt{Utils} stands for common operations used specifically for the new feature.

\subsection{Implementation details}

%Though the this feature does not use a lot of processing code, different

\subsubsection{Bitmap creation}

At creation, the scanned record must firstly be converted to a bitmap, so that it can be drawn on the panel. Most part of the process is implemented in the \texttt{BitmapFromData()} in the utility class.

As already explained, the raw data of the scanned record is stored as an array of floating-point values (see~\autoref{sec:3dcaptureprop}). They must then be converted and normalized to be stored as values in the range \numrange[range-phrase=--]{0}{255} to represents pixel values. The bitmap created has the \SI{8}{bpp} format, using a 256 colors palette of grayscale values, so that the memory is not wasted with other colors.

\subsubsection{Draw panel animation}

The main implementation point is to update and draw the panel. This part is handled using \gls{gdi}, provided in Microsoft .NET through the \texttt{System.Drawing} classes.

As its name implies, \emph{interactive} means to draw the objects several times per second, so that it is possible to output a smooth animation. The way WinForms are usually handled is not meant to perform animation. The panels are refreshed only when required, e.g. when a window has been hidden by another, or when it is resized to replace the components. To refresh the panel manually, it must be marked as invalid by calling the \texttt{Invalidate()} function.

To perform an animation, one may then use a \texttt{Timer} (provided in the \gls{api}) and, at each tick, update the view before invalidating the panel. The interval should be set to a value giving a high enough refresh rate. For example, with an interval of \SI{40}{\milli\second}, the corresponding refresh rate is $1/0.04 = \SI{25}{fps}$.

\subsubsection{Linear transformations}

Another important consideration is the transformations. Although there are not a lot of objects drawn on the panel, the correct positioning of all elements is the main point.

For example, the bitmap representing the record is placed regarding the user inputs. However, the relevant position is, from an external point of view, the coordinates in the record where the red triangle is pointing. On the other hand, from the drawing area perspective, the triangle is fixed at the top center. Therefore, to draw the bitmap at the correct location, the drawing coordinates must be inverted and shifted. When the targeted position is 30 pixels from the left and 200 from the top, the bitmap must in fact be translated by $(-30,-200)$ from the triangle tip.

There are different coordinate systems, as viewed in \autoref{fig:inttracktransfo}. Likewise, the zoom level influences the final position as well, and the final shift also depends on this factor.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{images/int-track-transfo}
\caption[Panel and record coordinate systems in the interactive tracking panel.]{Panel and record coordinate systems in the interactive tracking panel. The first one is represented in orange and the second in green. When the record is drawn at $(30,300)$, the bitmap is translated to the left and top.}
\label{fig:inttracktransfo}
\end{figure}

In fact, each object has its own properties. To be properly drawn on screen, their position expressed naturally must be converted to the panel coordinate system. The needed transformations for each element are summarized in \autoref{tab:transforms}.

The most effective and flexible way to easily handle these conversions is to alter the global transformation matrix before rendering each object, instead of applying manually the transformations to the point. This enables to keep the position in their natural logical coordinates. The corresponding conceptual code is presented in \autoref{lst:inttransfo}.

\begin{lstlisting}[language={[Sharp]C}, caption={Interactive panel drawing and coordinate systems transformation.}, label={lst:inttransfo}]
// Start all drawing at the panel center and tip of the red triangle
g.TranslateTransform(this.Width / 2, trianglePos.Size.Height);

// Save this base system
Matrix savedTransform = g.Transform;

// Coordinate system transformation
g.TranslateTransform(this.Width / 2, trianglePos.Size.Height);
g.ScaleTransform(zoomLevel, zoomLevel);

// Draw the record bitmap
Point renderPos = new Point(-position.X, -position.Y);
g.DrawImage(bmpRecord, renderPos);

// Set the translation transformation for the tracked points
g.TranslateTransform(-position.X, -position.Y);

// Draw tracked points...

g.Transform = savedTransform;

// Draw red triangle (no transformation needed)
trianglePos.Draw(g);

// Transformation for the blue triangle position
Matrix m = new Matrix();
m.Translate(this.Width / 2, 0);
m.Scale(zoomLevel, zoomLevel);
m.Translate(-position.X, 0);

Point[] trackPos = new Point[]{new Point(TrackedGrooveX, 0)};
m.TransformPoints(trackPos);

// Draw the blue triangle at right position
triangleTrack.TargetPosition = trackPos[0];
triangleTrack.Draw(g);
g.Transform = savedTransform;
\end{lstlisting}

\begin{table}[h!]
\begin{center}
\tabulinesep=3pt
\begin{tabu} to 0.9\textwidth {| X[-1m] | X[m] | X[m] |} %{>{\bfseries}lX}
    \everyrow{\hline}
    \hline
    \rowfont[c] \bfseries
    Object & Coordinates relative to & Necessary transformations \\
    Record bitmap & position in the record where the user is pointing  & Inverse translation of the position \newline Scaling of the current zoom level \\
    Tracking path & position in the record of the points building the line & Idem as the bitmap \\
    Red triangle & top center in panel coordinates & Translation to the center of the panel \\
    Blue triangle & X: real tracked position in record coordinates \newline Y: fixed in panel coordinates & X: idem as the bitmap \newline Y: no transformation needed \\
\end{tabu}
\end{center}
\caption{Transformation of the different objects in the interactive panel.}
\label{tab:transforms}
\end{table}

Firstly, the actual panel coordinates are translated to the center of the screen and below the red triangle. This sets the new basis for the panel coordinate system, with the origin starting at the tip of the latter. This initial transformation matrix is saved to be restored later on.

The bitmap and the tracked points are drawn in the same coordinate system. One can note that for the bitmap, the inversion is not applied to the current matrix using a negative scale, but is manually set by defining the \texttt{renderPos} variable. This is to avoid that the bitmap is rendered as if it was flipped, which is not the desired behavior. We just want its starting position to be altered.

The matrix is then reset to draw the red triangle. No transformation is needed as it is directly positioned at the very top center. Then, to draw the actual tracked position indicated by the blue triangle, the same transformations as for the bitmap must be applied for the X coordinates. However, we cannot just alter the current matrix. Indeed, the zoom would alter the triangle size as well. As for the record, we only want the position to be altered. The only way is then to define a new matrix and only apply the transformation to the point, before setting the position.

\subsubsection{Groove center approximation}

As explained in the previous section, the groove center is refined from the position indicated by the user. This is done by iterating $n$ points before and after current point in the same row, and return the deepest position. The $n$ value is determined using an approximated groove width and a tolerance factor $t$ in the range $[0,1]$. For example, if the groove width is $60$ and the tolerance $0.8$, then $n = \frac{60}{2} t = 24$.

The groove width is determined by analyzing the record at the start of the record. This step will be explained in \autoref{sec:groovebot}.

\section{Summary}

This part of the project ended with a new feature to the current system. The new interactive tracking enables to simplify the sometimes painful manual tracking. It provides a new way of tracking the grooves and several enhancements helping the operator to restore records. This feature is however not sufficient in practice, as in most cases the difficult part is to find the correct path when the record is cracked and the grooves possibly shifted.

The next chapter will present some ways to detect the cracks in a record. This will be a first step for the implementation of an automatic system to track damaged records, as well as a way of providing further information to the user for the manual tracking feature.

\chapter{Cracks detection}

The main problem to address in this project is that the current algorithms are unable to properly track (find) the grooves when a record is cracked.

This chapter will firstly summarize the current implemented algorithms and explain why they cannot be used as such on cracked records. Then, it will explain a way of finding the cracks and distinguish the different pieces delimited by them. Finally, the remaining work will be to track the grooves in each of these parts.

\section{Existing tracking methods}
\label{sec:trackmethods}

\subsection{Tracking line}

One of the currently implemented automatic tracking method, called \emph{track line}, tries to find the approximate edges of a groove. It is especially used on disc records in \gls{rene}. This is achieved by finding the peaks in intensity and keeping track of the groove edges by detecting the changing intensity (as seen in \autoref{sec:reneprocessing}). Then, it follows the corresponding X-position scanning the record downward and adjusting it to the deepest value.

When the bottom of the scanned record is reached, the tracking can simply continue at the top, meaning that a full revolution has been reached. The tracking is completed when the side of the record has been reached.

This method fails when there is just a little crack, because the depth is obviously completely wrong at these place, and the algorithm fails to find its way to the disc.

\subsection{Tracking depth}

The second method is the counterpart of the tracking line algorithm, operating in a similar way but specifically used for cylinders in \gls{prism}. The difference is that it tries to directly find the groove center instead of the edges. As the height values are expressively indicated by the 3D probe scanning, this can be done by looking for the deepest point in a local region of the record. The disc is then scanned downward the very same way as with the previous method.

\subsection{Tracking Fourier}

The second method uses a different approach. The binned image is scanned horizontally, giving the groove shapes for each row. Then, the Fast Fourier Transform algorithm is applied giving the frequency space of the signal. This enables to get the peak frequency and deduce the phase which gives the distance between two grooves. When the first groove has been tracked, the other ones can then be deduced by the computed phase.

This method works well when the records are not distorted, as the distance between two grooves remains invariable in the same row. Therefore, it is also inapplicable for cracked records for the same reasons.

\subsection{Conclusion}

The existing automatic tracking methods propose different ways which have proven to be effective for a large variety of records. However, this simple approach cannot be used anymore in the case of cracked records. The biggest issue is that when a crack appears, no information is relevant in the corresponding signal. It could be avoided until the damaged part ends up, but in this case the typical problem of shifting (see \autoref{sec:issueshift}) would make it almost impossible to follow correctly the good path.

Somehow, these cracks must be firstly detected in order to process the record correctly. The next sections explain ways to find cracks in the scanned records in order to distinguish the different pieces.

\section{Chunks detection}

As already seen in the previous sections we need a way to differentiate the pieces separated by cracks, which will now be called \emph{chunks} in the rest of this report. Rather than finding the cracks, the goal will be to find the chunks to be able to process them separately.

To detect them properly, a characteristic which differs in parts representing cracks and normal part of a record must be found. Then, some image processing algorithms must be applied in order to extract the contour of the chunk. These steps are explained in the next subsections.

\subsection{Cracked records characteristics}

The recording test set with specific damaged examples has already been presented in \autoref{sec:samplerec}. However, at this point, we need to investigate more deeply to find a way to clearly distinguish the cracks from the rest of a record.

For the records processed with \gls{3dprobe}, an early response to this problem is the information of the brightness intensity reflected by the probe. Let analyze what looks like a crack in terms of brightness. This first example in \autoref{fig:crackdepthbri} comes from the Graham Bell disc.

\begin{figure}[!ht]
    \centering
    \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{images/bell-crack-raw}
    \caption{View of the heightmap.}
    \label{fig:crackdepth}
    \end{subfigure}
    \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{images/bell-crack-bri}
    \caption{View of the brightness intensity.}
    \label{fig:crackbri}
    \end{subfigure}
    \caption{A crack in the Bell record visualized as depth and brightness intensity.}
    \label{fig:crackdepthbri}
\end{figure}

On \autoref{fig:crackdepth}, it is quite difficult to spot a clear difference. It seems to be brighter but some horizontal lines cross the chunk. In fact, these peculiar values inside a chunk occur because of a feature implemented in \gls{prism}. When the acquired values of the beam are out of range, the probe return the maximum height value, appearing in white in the image. However, at loading time, the bad pixels detected as totally wrong are replaced by the weighted average of their neighbors. This results in these horizontal lines in \autoref{fig:crackdepth} making difficult to extract the cracks. This feature can be deactivated, making the cracks more visible in bright values, but also resulting in other bad points (not necessarily in cracks) not being fixed.

On the brightness image (\autoref{fig:crackbri}), the pixels appear much darker in the crack area. This happens in this case because the material of the underneath support reflects less brightness than the normal surface. Of course, in the general case the intensity depends on the material. For example, in a disc with metallic support, the brightness would be much higher instead. However, in all the samples used in this project from \gls{3dprobe}, the reflected brightness is clearly lower than the surface. This property will then be used to find the chunks.

\subsubsection{Differences with VisualAudio}

On the cracked discs processed by VisualAudio, the cracks are quite big and usually bigger than the actual grooves. The process to find cracks starts by decimating the image, e.g. by a factor of 16. The cracks detection can then be processed quickly.

However, in our case, the cracks appearing in wax cylinders and discs can be very small, usually smaller than an actual groove. If the image is binned, two much information is lost to properly find all cracks. The processing must then be applied on the original image. The size is bigger but this is not an issue with \gls{3dprobe}. Firstly, the scan is not separated in different files and has not to be merged. The resulting image is also smaller, as the number of points per line is smaller (see \autoref{sec:3dcaptureprop}) as well as the sampling frequency detailed in \eqref{eq:samprate3d}. The multi-pass scan is not an issue, as for vertically-cut records the passes are usually averaged instead of kept as individual values. Therefore, the final image size is not multiplied.

\subsection{Filtering}

When detecting a feature on a digitalized image, the first task is to apply a filter to eliminate the noise present in the image. What is typically needed is a way of smoothing (blurring) the image. Different filters can be applied to clean the source image.

\subsubsection{Convolution}

The mathematical operation for applying a filter is called a convolution (noted $\ast$). In the case of an image, the source can be viewed as matrix $A$. The new image is computed by applying a convolution matrix, also called \emph{kernel}, which contains different weights . To compute the new pixel value, the weighted sum of the current pixel and all the pixels around is calculated using the coefficients in the kernel.

\begin{equation}
\label{eq:convolsimple}
B =
\begin{bmatrix}
1/9 & 1/9 & 1/9 \\
1/9 & 1/9 & 1/9 \\
1/9 & 1/9 & 1/9
\end{bmatrix}
\ast A
\end{equation}

In \eqref{eq:convolsimple}, the $3 \times 3$ kernel results in a simple blur consisting of the average of all pixel values around. The dimensions of a convolution matrix must be an odd value but it is not necessarily square.

\subsubsection{Blurring types}

Other blurring types can be used depending on the desired results. A well-known filter is the Gaussian blur. Instead of using the same coefficients for every pixels, they are calculated using a Gaussian distribution in two dimensions. It is computed from the product of two Gaussians parameterized by $x$ and $y$. The corresponding formula is given in \eqref{eq:gauss2d}.

\begin{equation}
\label{eq:gauss2d}
G(x) = \frac{1}{2\pi\sigma^2}e^{-\frac{x^2+y^2}{2\sigma^2}}
\end{equation}

An example of a $5 \times 5$ kernel applying a Gaussian blur with $\sigma = 0.8$ is approximated in \eqref{eq:convolgauss}. The result is that the current pixel is much more weighted than the distant neighbors. The visual representation of the two dimensional Gaussian is viewed in \autoref{fig:convolgauss}.

\begin{equation}
\label{eq:convolgauss}
{\scriptsize
\begin{bmatrix}
0.0005 & 0.0050 & 0.0109 & 0.0050 & 0.0005 \\
0.0050 & 0.0521 & 0.1139 & 0.0521 & 0.0050 \\
0.0109 & 0.1139 & 0.2487 & 0.1139 & 0.0109 \\
0.0050 & 0.0521 & 0.1139 & 0.0521 & 0.0050 \\
0.0005 & 0.0050 & 0.0109 & 0.0050 & 0.0005 \\
\end{bmatrix}
}
\end{equation}

\begin{figure}[!ht]
\centering
\begin{tikzpicture}
\begin{axis}[width=0.6\textwidth]
\addplot3[surf,domain=-2:2] {1 / (2 * pi * 0.8^2) * exp( -(x^2+y^2) / (2 * 0.8^2) )};
\end{axis}
\end{tikzpicture}
\caption{Visualization of the two-dimensional Gaussian with $\sigma = 0.8 $ .}
\label{fig:convolgauss}
\end{figure}

Another common filtering method is the median blur. The principle is slightly different than a convolution. Instead of computing a weighted sum, the new pixel value is computed by taking the median of the values selected by the kernel. It is no longer an averaging but a sorting operation. The selected value is thus an existing one and is less subject to degenerate pixels. The outcome is that the median filter preserves edges better than the other filters. The different filtering methods can be seen in \autoref{fig:filtermeth}.

All the filters in this example remove the noise in the image. The regular blur seems to remove information on the cracks while the Gaussian filter gives a better result (the crack edges are less blurred). The crack area is even better preserved with the median filter.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.9\textwidth]{images/filter-methods}
\caption[Visualization of the different filtering methods]
{Visualization of the different filtering methods with kernels of dimension $7 \times 7$. The top left part is the source image and on the right is the simple constant blur. The two bottoms parts are respectively the Gaussian and median filters.}
\label{fig:filtermeth}
\end{figure}

\subsection{Segmentation}

Once the noise is removed in the source image, the next step is to do segmentation of the image. This process groups the pixels with common properties that we want to keep as valuable information, and distinguishes them from the rest (commonly called background). In this case, we want to keep the information on the chunks and remove the cracks.

\subsubsection{Histogram}

A common tool helping for the segmentation operation is the histogram. An histogram represents the statistical distribution of a variable. Therefore, computing the histogram of an image means to compute the number of occurrences of each pixel values (usually in the range \numrange[range-phrase=--]{0}{255} for a bitmap). In our case this corresponds to the brightness intensity.

The histogram of a portion of the brightness image from a cracked disc can be seen in \autoref{fig:histocrack}.

\begin{figure}[!ht]
\centering
\begin{tikzpicture}
\begin{axis}[width=0.7\textwidth,xlabel=Intensity value,ylabel=Frequency]
\addplot +[mark=none, fill=blue] table[x expr=\coordindex,y=y] {graphs/histo-crack.dat};
\end{axis}
\end{tikzpicture}
\caption{Histogram of a cracked record portion.}
\label{fig:histocrack}
\end{figure}

This histogram shows clearly different peaks on the intensity value. The first peak represents very dark pixel values. As predicted, this is the intensity inside the crack area, which is clearly detached from the rest of the image. The cracks is approximately represented by the intensity between \numrange[range-phrase=--]{0}{10} and the rest of the image in the intensity \numrange[range-phrase=--]{11}{255}.

\subsubsection{Thresholding}

At this step, we have the information to separate the regular record surface from the cracks.

\todo{Complete section}

\subsubsection{Brightness normalization}

%TODO normalization in PRISM

\subsection{Cleaning}

\subsection{Contours extraction}

\subsection{Implementation and results}

\section{Finding grooves}
\label{sec:groovebot}

Another important thing, while manually tracking a record, is to be able to clearly find the groove bottoms. This seems not to be an issue as the groove bottoms are clearly seen in a lower intensity in \gls{prism} (and a lighter brightness with \gls{rene}). In fact, this becomes relevant when the disc is heavily cracked and separated into pieces. The main point is then to correctly match the pieces together, while the tracking inside a piece itself is easy to perform. The goal is to be able to bring out the groove bottoms at the bottom and top of all pieces, or chunks.

This feature is a bridge between a manual and an automatic solution. As it would be useful for the user to view this information, it will also be required for an automatic tracking system, to be able to reassemble them in a next step. The feature requires two big steps: find the groove bottoms and find the cracks.

\subsection{Finding groove bottoms}

A first step is to find the groove bottoms on a given Y-position. The usual tracking methods (see~\autoref{sec:trackmethods}) do not need to find separate bottoms because once a groove is found, it can be followed until the end. This property is no more true on a damaged disc where the different parts can be shifted or even sometimes lost.

However, pointing out the position where the bottoms are located in an horizontal line is possible, using a adequate algorithm.

\subsubsection{Peak detection}

The values on an horizontal line on a record scan can be seen as a one-dimensional signal. To find the bottoms on a signal, one cannot use the simple mathematical derivative because the signal is too noisy. A lot of variation can happen between two different values, because the signal is not smooth as if given by a simple mathematical function. One must then use a peak detection algorithm.

Different algorithms exist. For example, one can just smooth the signal by averaging it (low-pass filter) and then use the zero-derivate method. However, a simple well-suited method that does not alter the original signal is presented in \cite{peak12}. The idea is to define peaks and valleys. In fact, a peak is a location where the values are the highest between two valleys. A delta value defines the minimum Y distance between a peak and the next valley.

\autoref{fig:graphpeakdet} presents a graph with the values.

\begin{figure}[!ht]
%\tikzsetnextfilename{peak-detect-ex}
\centering
\begin{tikzpicture}
\begin{axis}[width=0.9\textwidth,unit vector ratio*=1 1 1]
%,xlabel=x,ylabel=value,xmin=0, xmax=2
\addplot +[mark=none] table[x expr=\coordindex,y=y] {graphs/peak-detect-ex.dat};
\addplot +[only marks, mark=*,forget plot, mark options={fill=red,draw=red}] table[x=xmin,y=ymin] {graphs/peak-detect-ex.dat};
\addplot +[only marks, mark=*, mark options={fill=green,draw=green}] table[x=xmax,y=ymax] {graphs/peak-detect-ex.dat};
\end{axis}
\end{tikzpicture}
\caption{Result of the peak detection algorithm.}
\label{fig:graphpeakdet}
\end{figure}

\todo{Complete the section}

%\section{Current issue}
%
%TODO.
%
%\section{}
%
%TODO.

%\chapter{Reassembling}
%
%TODO.

%\chapter{Tests and extraction of the sample recordings}
%
%TODO.

%\chapter{Conclusion}
%
%TODO.

%------------------------ Float samples ------------------------

%\begin{figure}[!ht]
%\centering
%\includegraphics[width=0.7\textwidth]{images/logo_lbnl}
%\caption{Image caption.}
%\label{fig:figname}
%\end{figure}

%\begin{table}[!ht]
%\begin{center}
%\begin{tabular}{| l c r |}
%    \hline
%    1 & 2 & 3 \\
%    4 & 5 & 6 \\
%    7 & 8 & 9 \\
%    \hline
%\end{center}
%\caption{A table.}
%\label{tab:test}
%\end{table}

%\begin{lstlisting}[language=C++, caption={Test listing}, label={lst:listingname}]
%// Comment
%int i;
%char c;
%\end{lstlisting}

%\autoref{eq:solve} with variable $s$ such as:
%\begin{equation} \label{eq:solve}
%s = [a_0, (a_0 + a_1), ..., (a_0 + a_1 + ... + a_{n-1})].
%\end{equation}

%\begin{figure}[!ht]
%\centering
%\begin{tikzpicture}
%\begin{axis}[xlabel=Hello 100 $x$,ylabel={$f(x) = x^2 - x + 4$},
%%height=5.2cm, width=\textwidth,
%]%xtick={0,0.5,...,20},]
%%xmin=0, xmax=2]
%%\addplot[domain=-10:10,color=blue,mark=*,mark size=1pt]{x^2 - x + 4};
%\addplot[domain=-10:10,color=blue,mark=*,samples=21]{x^2 - x + 4};
%\end{axis}
%\end{tikzpicture}
%\caption{Graph caption.}
%\label{fig:graphname}
%\end{figure}